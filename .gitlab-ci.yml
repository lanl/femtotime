# This is a sample GitLab CI/CD configuration file that should run without any modifications.
# It demonstrates a basic 3 stage CI/CD pipeline. Instead of real tests or scripts,
# it uses echo commands to simulate the pipeline execution.
#
# A pipeline is composed of independent jobs that run scripts, grouped into stages.
# Stages run in sequential order, but jobs within stages run in parallel.
#
# For more information, see: https://docs.gitlab.com/ee/ci/yaml/index.html#stages

stages:          # List of stages for jobs, and their order of execution
  - prepare
  - test

prepare-job:
  stage: prepare
  cache:
    paths:
      - /builds/diorama/${CI_PROJECT_NAME}/*
      - /builds/diorama/${CI_PROJECT_NAME}
  artifacts:
    when: 
    paths:
      - /builds/diorama/${CI_PROJECT_NAME}/*
      - /builds/diorama/${CI_PROJECT_NAME}
  script:
    - echo "not much prep"

unit-test-job:   # This job runs in the test stage.
  stage: test    # It only starts when the job in the build stage completes successfully.
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
      when: always
    - if: $CI_PIPELINE_SOURCE == "push"
      when: always
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - when: never
  artifacts:
    when: always
    paths:
      - _mbuild/cppunitTestResults.xml
      - _mbuild/meson-logs/testlog.junit.xml
    reports:
      junit: _mbuild/meson-logs/testlog.junit.xml
  script:
    # - . /usr/local/src/lanl-proxy-bashrc-snippet
    # - export DIO_REPO_BASE=/builds/diorama
    # - export DIO_LOCAL_PREFIX=${CI_PROJECT_DIR}/ULOCAL
    # - echo "setting diorama and other path variables based on $DIO_LOCAL_PREFIX"
    # - . /usr/share/diorama-bootstrap/diorama-bashrc-snippet
    - export PATH=/root/.local/bin:/opt/rh/devtoolset-11/root/usr/bin:$PATH
    # - export PATH=/root/.local/bin:$PATH
    - git branch
    - echo "Building and running unit tests..."
    - /bin/rm -rf _mbuild
    - meson _mbuild --prefix=$DIO_LOCAL_PREFIX
    - meson test -C _mbuild --suite unit
    - echo "Ran the meson unit tests."
